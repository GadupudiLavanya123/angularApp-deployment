name: Deploy Angular to IIS Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the code
      - name: Checkout code
        uses: actions/checkout@v3

      # Step 2: Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '16'

      # Step 3: Install dependencies and build Angular project
      - name: Install dependencies
        run: npm install

      - name: Build Angular app
        run: npm run build -- --prod

      # Step 4: Deploy to IIS server using PowerShell
      - name: Deploy to IIS server
        uses: azure/powershell@v1
        with:
          azPSVersion: '7.5.0' # Specify the Azure PowerShell version
          inlineScript: |
            $Server = 'LAPTOP-AL3ULK55'
            $DeployPath = 'C:\inetpub\wwwroot\my-angular9-app'
            $BuildPath = 'dist/my-angular9-app'

            Write-Host "Connecting to IIS server at $Server..."

            # Clear existing files
            Invoke-Command -ComputerName $Server -ScriptBlock {
              param ($DeployPath)
              Remove-Item -Recurse -Force -Path $DeployPath\*
            } -ArgumentList $DeployPath

            # Copy new files
            Invoke-Command -ComputerName $Server -ScriptBlock {
              param ($DeployPath, $BuildPath)
              New-Item -ItemType Directory -Path $DeployPath -Force
              Copy-Item -Path $BuildPath\* -Destination $DeployPath -Recurse
            } -ArgumentList $DeployPath, $BuildPath

            # Restart IIS
            Invoke-Command -ComputerName $Server -ScriptBlock { iisreset }
     
